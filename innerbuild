#/bin/sh

set -e
set -x

KVERS=3.3.4-4~experimental.1
ZFSVER=0.6.0-rc8

export DEBFULLNAME="Nick Black"
export DEBEMAIL="nick.black@sprezzatech.com>"

cd /
git clone git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git \
	-b linux-3.3.y --single-branch
cd linux-stable
svn co svn://svn.debian.org/svn/kernel/dists/trunk/linux-2.6/debian/ debian
dch --newversion=$KVERS

# FIXME remove unused files from debian/installer/modules/*
#	crypto.modules: serpent
# 
# FIXME first clean out the patchseries files
tar -cjvf /linux-$KVERS.tar.bz2 -C.. linux-$KVERS --exclude=debian
python debian/bin/genorig.py /linux-$KVERS.tar.bz2
debian/rules orig
debian/rules debian/control

# rebuild the abi
# redefine it in debian/config/defines FIXME
fakeroot debian/rules debian/control-real

# FIXME need a configuration file
make deb-pkg -j8
dpkg -i ../linux-headers*.deb

cd /spl-"$ZFSVER"
dpkg-buildpackage -j8
cd /zfs-"$ZFSVER"
dpkg-buildpackage -j8
cd /root
cd /debian-installer-*
dpkg-buildpackage -uc -us
