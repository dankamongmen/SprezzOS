#/bin/sh

set -e
set -x

KVERS=3.3.6-1
DEBKEY=AAE15FF2
ZFSVER=0.6.0-rc8

export DEBFULLNAME="Nick Black"
export DEBEMAIL="nick.black@sprezzatech.com>"

cd /
# FIXME kill hardcodings
wget ftp://ftp.kernel.org/pub/linux/kernel/v3.x/linux-3.3.6.tar.bz2
tar xzvf linux-3.3.6.tar.bz2
cd linux-stable
git clone git://github.com/dankamongmen/sprezzos-kernel-packaging.git debian
make -f debian/rules source-all
dch --newversion=$KVERS
make -f debian/rules clean
python debian/bin/genorig.py .
debian/rules orig

cd debian/installer/amd64
# FIXME there's a lot more crap than this we need write...
cat > ../../control <<EOF
Source: linux-2.6
Section: kernel
Priority: optional
Maintainer: Debian Kernel Team <debian-kernel@lists.debian.org>
Uploaders: Bastian Blank <waldi@debian.org>, Frederik Sch√ºler <fs@debian.org>, maximilian attems <maks@debian.org>, Ben Hutchings <ben@decadent.org.uk>
Standards-Version: 3.9.2
Build-Depends: debhelper (>> 7), cpio, module-init-tools, python (>= 2.6.6-3~), lzma [armel], kernel-wedge (>= 2.83), gcc-4.5 [alpha], gcc-4.6 [amd64 armel armhf i386 ia64 m68k mips mipsel powerpc ppc64 s390 s390x sh4 sparc sparc64], gcc-4.4 [hppa], binutils-hppa64 [hppa], gcc-4.4-hppa64 [hppa]
Build-Depends-Indep: bzip2, xmlto
Vcs-Svn: svn://svn.debian.org/svn/kernel/dists/trunk/linux-2.6/
Vcs-Browser: http://anonscm.debian.org/viewvc/kernel/dists/trunk/linux-2.6/

EOF
kernel-wedge gen-control $KVERS >> ../../control
cd -

# this is supposed to fail. i know. check the output if you don't believe me.
#debian/rules debian/control || true
# rebuild the abi FIXME

dpkg-buildpackage -j8 -k$DEBKEY
cp debian/config/kernelarch-x86/config-arch-64 .config
make oldconfig
make -j8 bzImage
make -j8 modules

ln -s /linux-stable /buildkernel

cd /spl-"$ZFSVER"
tar -cjvf ../spl_0.6.0~rc8.orig.tar.bz2 -C.. --exclude=debian spl-0.6.0-rc8
dpkg-buildpackage -j8 -k$DEBKEY
cd /zfs-"$ZFSVER"
tar -cjvf ../zfs_0.6.0~rc8.orig.tar.bz2 -C.. --exclude=debian zfs-0.6.0-rc8
dpkg-buildpackage -j8 -k$DEBKEY

mv /*.udeb /d-i/installer/build/localudebs/
cd /d-i/packages
cd main-menu
patch -p1 < /d-i-patches/packages/main-menu.diff 
cd ../partman-basicfilesystems/
patch -p1 < /d-i-patches/packages/partman-basicfilesystems.diff 
cd ../rootskel-gtk
cp /d-i-patches/packages/rootskel-gtk/src/usr/share/graphics/logo_debian.png src/usr/share/graphics/
cd ..
for i in * ; do cd "$i" && dpkg-buildpackage -j8 ; cd - ; done
cd /d-i/installer
cp -v /d-i/packages/*udeb build/localudebs
dpkg-buildpackage -j8 -k$DEBKEY
