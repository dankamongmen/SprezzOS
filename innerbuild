#/bin/sh

set -e
set -x

KVERS=3.3.6-1
DEBKEY=AAE15FF2
ZFSVER=0.6.0-rc8

export DEBFULLNAME="Nick Black"
export DEBEMAIL="nick.black@sprezzatech.com>"

cd /
git clone git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git \
	-b linux-3.3.y --single-branch
cd linux-stable
git clone git://github.com/dankamongmen/sprezzos-kernel-packaging.git debian
dch --newversion=$KVERS
python debian/bin/genorig.py .
debian/rules orig

cd debian/installer/amd64
kernel-wedge gen-control $KVERS > ../../
cd -

# this is supposed to fail. i know. check the output if you don't believe me.
#debian/rules debian/control || true
# rebuild the abi FIXME

dpkg-buildpackage -j8 -k$DEBKEY
cp debian/config/kernelarch-x86/config-arch-64 .config
make oldconfig
make -j8 bzImage
make -j8 modules

ln -s /linux-stable /buildkernel

cd /spl-"$ZFSVER"
tar -cjvf ../spl_0.6.0rc8.orig.tar.bz2 -C.. --exclude=debian spl-0.6.0-rc8
dpkg-buildpackage -j8 -k$DEBKEY
cd /zfs-"$ZFSVER"
tar -cjvf ../zfs_0.6.0~rc8.orig.tar.bz2 -C.. --exclude=debian zfs-0.6.0-rc8
dpkg-buildpackage -j8 -k$DEBKEY

mv /*.udeb /d-i/installer/build/localudebs/
# patch d-i with contents of /d-i-diffs/ FIXME
cd /d-i/packages
for i in * ; do cd "$i" && dpkg-buildpackage -j8 ; cd - ; done
cd /d-i/installer
cp -v /d-i/packages/*udeb build/localudebs
dpkg-buildpackage -j8 -k$DEBKEY
