#/usr/bin/env bash

set -e
set -x

usage () { echo "usage: `basename $0` kernver zfsver" ; return 0 ; }
usageerr () { usage >&2 ; return 1 ; }

[ $# -eq 2 ] || usageerr

UPSTREAM="$1"
ZFSVER="$2"

ABI=1
KVERS="$UPSTREAM-$ABI"
DEBKEY=AAE15FF2

export DEBFULLNAME="Nick Black"
export DEBEMAIL="<nick.black@sprezzatech.com>"

# UEFI Development Kit 2010, unpackaed already by Make
cd /usr/local/UDK2010/MyWorkSpace
. edksetup.sh
sed -i -e"s/^ACTIVE_PLATFORM .*\$/ACTIVE_PLATFORM=MdeModulePkg\/MdeModulePkg.dsc/" Conf/target.txt
sed -i -e"s/^TARGET .*\$/TARGET=RELEASE/" Conf/target.txt
sed -i -e"s/^TARGET_ARCH .*\$/TARGET_ARCH=X64/" Conf/target.txt
sed -i -e"s/^TOOL_CHAIN_TAG .*\$/TOOL_CHAIN_TAG=GCC46/" Conf/target.txt
sed -i -e"s/-melf_x86_64//g" Conf/tools_def.txt
make -C /usr/local/UDK2010/MyWorkSpace/BaseTools/Source/C
build

# Build our own packages of certain udebs. Don't try rebuilding all; that leads
# to divergence from upstream, and some of them fail.
cd /d-i/packages
for i in apt-setup debootstrap main-menu partman-basicfilesystems rootskel rootskel-gtk ; do
	cd "$i"
	dpkg-buildpackage -j8
	cd -
done

cp -v /*.udeb /d-i/packages/*udeb /d-i/installer/build/localudebs

cd /d-i/installer
dpkg-buildpackage -j8 -k$DEBKEY
