#/bin/sh

set -e
set -x

usage () { echo "usage: `basename $0` kernel-ver" ; return 0 ; }
usageerr () { usage >&2 ; return 1 ; }

[ $# -eq 1 ] || usageerr

UPSTREAM="$1"

ABI=1
KVERS="$UPSTREAM-$ABI"
DEBKEY=AAE15FF2
ZFSVER=0.6.0-rc8

export DEBFULLNAME="Nick Black"
export DEBEMAIL="nick.black@sprezzatech.com>"

#cd /
#tar xjvf "linux-$UPSTREAM.tar.bz2"
#cd "linux-$UPSTREAM"
#git clone git://github.com/dankamongmen/sprezzos-kernel-packaging.git debian

cd "/linux-$UPSTREAM"

cd debian/installer/amd64
kernel-wedge gen-control $KVERS >> ../../control
cd -

# This must be run twice. The first time, it intentionally fails. Don't
# believe me? Run it yourself and see.
make -f debian/rules debian/control-real || true # Creates Source: entry in /control
make -f debian/rules source-all || true
# FIXME ABINAME is being passed around already here
make -f debian/rules source-all

make -f debian/rules clean || true
python debian/bin/genorig.py "/linux-$UPSTREAM.tar.bz2"
debian/rules orig

# rebuild the abi FIXME
# FIXME ugh
#sed -i -e"s/3.3.0-1/$KVERS/g" debian/bin/patch.apply
#sed -i -e"s/3.3.0-1/$KVERS/g" debian/rules.gen
#sed -i -e"s/3.3.0-1/$KVERS/g" debian/control

dpkg-buildpackage -j8 -k$DEBKEY
cp debian/config/kernelarch-x86/config-arch-64 .config
make oldconfig
make -j8 bzImage
make -j8 modules

ln -s "/linux-$UPSTREAM" /buildkernel

cd /spl-"$ZFSVER"
tar -cjvf ../spl_0.6.0~rc8.orig.tar.bz2 -C.. --exclude=debian spl-0.6.0-rc8
dpkg-buildpackage -j8 -k$DEBKEY
cd /zfs-"$ZFSVER"
tar -cjvf ../zfs_0.6.0~rc8.orig.tar.bz2 -C.. --exclude=debian zfs-0.6.0-rc8
dpkg-buildpackage -j8 -k$DEBKEY

mv /*.udeb /d-i/installer/build/localudebs/
cd /d-i/packages
cd main-menu
patch -p1 < /d-i-patches/packages/main-menu.diff
cd ../partman-basicfilesystems/
patch -p1 < /d-i-patches/packages/partman-basicfilesystems.diff
cd ../rootskel-gtk
cp /d-i-patches/packages/rootskel-gtk/src/usr/share/graphics/logo_debian.png src/usr/share/graphics/
cd ..

# Build our own packages of certain udebs. Don't try rebuilding all; that leads
# to divergence from upstream, and some of them fail.
for i in main-menu partman-basicfilesystems rootskel-gtk ; do
	cd "$i"
	dpkg-buildpackage -j8
	cd -
done

cd /d-i/installer
patch -p1 < /d-i-patches/installer.diff
cp -v /d-i/packages/*udeb build/localudebs
dpkg-buildpackage -j8 -k$DEBKEY
