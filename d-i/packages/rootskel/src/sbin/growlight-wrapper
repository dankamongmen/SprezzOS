#!/bin/sh

# invoked by inittab in installer. on success, kill the growlight-wait process
# with SIGUSR1. otherwise, kill it with some other signal. if this succeeds (ie
# there is really a process waiting on us), chvt back to tty1.

TARGET=/target

# Otherwise we get a diagnostic when libzfs is first entered (despite the fact
# that it immediately loads the module successfully).
modprobe zfs

while true ; do
	mkdir -p "$TARGET"
	/sbin/growlight-tty --target="$TARGET"
	if [ $? -eq 0 ] ; then
		kill -s SIGHUP `pidof growlight-wait`
		if [ $? -eq 0 ] ; then
			chvt 1
		fi
	else
		kill -s SIGKILL `pidof growlight-wait`
		if [ $? -eq 0 ] ; then
			chvt 1
		fi
	fi
done
