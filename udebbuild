#/usr/bin/env bash

set -e
set -x

. ~/.bashrc

usage () { echo "usage: `basename $0`" ; return 0 ; }
usageerr () { usage >&2 ; return 1 ; }

[ $# -eq 0 ] || usageerr

cd /s-i/packages/main-menu && patch -p1 < /s-i-patches/packages/main-menu.diff
cd /s-i/packages/rootskel && patch -p1 < /s-i-patches/packages/rootskel.diff
cd /s-i/packages/rootskel && cp -vr /s-i-patches/packages/rootskel/src/usr src/
cd /s-i/packages/rootskel && cp -vr /s-i-patches/packages/rootskel/src/sbin/* src/sbin/

cd /s-i/packages

# Build our own packages of certain udebs. Don't try rebuilding all; that leads
# to divergence from upstream, and some of them fail.
for i in main-menu rootskel tzsetup netcfg ; do
	cd "$i"
	apt-get -y build-dep "$i"
	dpkg-buildpackage -j8 -k$DEBKEY
	cd -
done

# Send them to the repo...
