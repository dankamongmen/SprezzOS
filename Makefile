.DELETE_ON_ERROR:
.PHONY: all test clean cleanchroot clobber subupdate refit

# Kernel version
UPSTREAM:=3.4.3
KVER:=$(UPSTREAM)-1
ZFSVER:=0.6.0~rc9

CHROOT:=unstable
DI:=debian-installer_20120509
DIBUILD:=$(CHROOT)/d-i/installer/build

# Helper scripts
BUILD:=build
BUILDIN:=innerbuild
MAKECD:=makecd
RUNCD:=runcd
UPDATE:=update

# simple-cdd builds from subdirs, and needs full paths as input
CONF:=$(shell pwd)/profiles/SprezzOS.conf

IMG:=SprezzOS.iso
TESTDISK:=kvmdisk.img
PACKAGES:=packages.tgz
CONFIN:=SprezzOS.conf.in
PACKIN:=SprezzOS.packages.in
DIDEB:=/d-i/$(DI)_amd64.deb
KERNBALL:=linux-$(UPSTREAM).tar.bz2
PROFILE:=profiles/SprezzOS.packages
UDK:=UDK2010.SR1.Complete.MyWorkSpace.zip
UDKDIR:=/usr/local/UDK2010

all: $(IMG) refit

test: $(RUNCD) $(TESTDISK) all
	./$< $(TESTDISK) $(ISO)

$(IMG): $(MAKECD) $(CONF) $(PROFILE) $(CHROOT)/$(DIDEB)
	./$< $@ $(KVER) $(ZFSVER)

$(PROFILE): $(PACKIN)
	@[ -d $(@D) ] || mkdir -p $(@D)
	( echo "# Automatically generated by Make" && echo "linux-image-$(KVER)-amd64" && cat $^ ) > $@

$(CONF): $(CONFIN)
	@[ -d $(@D) ] || mkdir -p $(@D)
	( echo "# Automatically generated by Make" && cat $^ && echo custom_installer=\"$(shell pwd)/dest\" ) > $@

$(CHROOT)/$(DIDEB): $(CHROOT)/linux-$(UPSTREAM)/debian
	sudo chroot $(CHROOT) /$(BUILDIN) $(UPSTREAM) $(ZFSVER)

$(CHROOT)/linux-$(UPSTREAM)/debian: $(CHROOT)/$(KERNBALL)
	sudo chroot $(CHROOT) tar xjf $(<F)
	sudo chroot $(CHROOT) git clone git://github.com/dankamongmen/sprezzos-kernel-packaging.git linux-$(UPSTREAM)/debian

$(CHROOT)/$(KERNBALL): $(CHROOT)/$(BUILDIN)
	wget -P $(CHROOT) ftp://ftp.kernel.org/pub/linux/kernel/v3.x/linux-$(UPSTREAM).tar.bz2

$(CHROOT)/$(BUILDIN): $(BUILD) $(BUILDIN) $(PACKAGES)
	@[ ! -e $(@D) ] || { echo "$(@D) exists. Remove it with 'make cleanchroot'." >&2 ; exit 1 ; }
	./$< $(@D)
	cp $(BUILDIN) $@

cleanchroot:
	sudo umount $(CHROOT)/proc $(CHROOT)/sys || true
	sudo rm -rf $(CHROOT)

$(PACKAGES): $(UPDATE)
	./$< $@

refit: $(CHROOT)/$(UDKDIR)/UDK2010.SR1.MyWorkSpace.zip
	sudo chroot $(CHROOT) /bin/sh -c "cd $(UDKDIR) && unzip $(<F)"
	sudo chroot $(CHROOT) /bin/sh -c "cd $(UDKDIR)/MyWorkSpace && tar xvf ../BaseTools\(Unix\)_UDK2010.SR1.tar"

$(CHROOT)/$(UDKDIR)/UDK2010.SR1.Complete.MyWorkSpace.zip: $(CHROOT)/$(BUILDIN) $(UDK)
	cp -fv $(UDK) $(CHROOT)
	@[ ! -e $(@D) ] || sudo rm -rf $(@D)
	@[ -e $(@D) ] || sudo chroot $(CHROOT) mkdir $(UDKDIR)
	sudo chroot $(CHROOT) unzip $(UDK) -d $(UDKDIR)

$(UDK):
	wget -O $@ http://sourceforge.net/projects/edk2/files/UDK2010%20Releases/UDK2010.SR1/UDK2010.SR1.Complete.MyWorkSpace.zip/download

subupdate:
	cd fwts && git pull origin HEAD && cd -
	git submodule update

clean: cleanchroot
	rm -rf tmp $(TESTDISK) images $(CONF) $(IMG)

clobber: clean
	rm -f $(PACKAGES) $(UDK)
